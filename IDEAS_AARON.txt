#!/bin/bash

# Verifica que se haya proporcionado un archivo YAML de entrada como argumento
if [ $# -eq 0 ]; then
    echo "Uso: $0 archivo_de_entrada.yml"
    exit 1
fi

input_file="$1"

# Verifica que el archivo de entrada exista
if [ ! -f "$input_file" ]; then
    echo "Error: El archivo $input_file no existe."
    exit 1
fi

# Función para generar archivos YAML de salida para cada job
generate_yaml_files() {
    local jobs_data="$1"
    local project="$2"
    local timestamp="$3"
    
    # Itera sobre cada job en el bloque jobs
    while IFS= read -r job; do
        job_name=$(echo "$job" | grep -oP '^\s+name:\s+\K.*')
        version=$(echo "$job" | grep -oP '^\s+version:\s+\K.*')
        jira_id=$(echo "$job" | grep -oP '^\s+jira_id:\s+\K.*')
        
        # Genera el nombre del archivo de salida
        output_file="${job_name}_${timestamp}.yml"
        
        # Crea el contenido del archivo YAML de salida
        cat <<EOF > "$output_file"
project_name: $project
job_name: $job_name
fid: $jira_id
version: $version
EOF
        
        echo "Archivo generado: $output_file"
    done <<< "$jobs_data"
}

# Extrae el bloque 'jobs' del archivo YAML de entrada
jobs_block=$(sed -n '/^\s*jobs:/,/^ *$/p' "$input_file" | sed '1d;$d')

# Extrae el proyecto y el timestamp del archivo YAML de entrada
project=$(grep -oP '^\s+project:\s+\K.*' "$input_file")
timestamp=$(grep -oP '^\s+timestamp:\s+\K.*' "$input_file")

# Llama a la función para generar los archivos YAML de salida por cada job
generate_yaml_files "$jobs_block" "$project" "$timestamp"
