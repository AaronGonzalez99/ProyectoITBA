#!/bin/bash

# Variables
INPUT_FILE="input.yml"  # Path to the input YAML file
PROJECT_NAME="your_project_name"
FID="your_fid"
OUTPUT_DIR="./output_files"
COMMIT_MESSAGE="Auto-generated YAML files with updated version"

# Create output directory if it doesn't exist
mkdir -p $OUTPUT_DIR

# Extract jobs section from the YAML file
jobs_section=$(awk '/jobs:/,/^$/' $INPUT_FILE)

# Extract individual job details
job_entries=$(echo "$jobs_section" | awk '/- name:/ {print NR}' | tac)
prev_line=$(echo "$jobs_section" | wc -l)
for line in $job_entries; do
    job_block=$(echo "$jobs_section" | sed -n "${line},${prev_line}p")
    job_name=$(echo "$job_block" | grep 'name:' | awk '{print $2}')
    job_version=$(echo "$job_block" | grep 'version:' | awk '{print $2}')
    prev_line=$((line - 1))

    # Create new YAML content
    new_yaml=$(cat <<EOF
project_name: $PROJECT_NAME
job_name: $job_name
fid: $FID
version: $job_version
EOF
    )

    # Write the new YAML to a file
    output_file="$OUTPUT_DIR/${job_name}_new.yml"
    echo "$new_yaml" > "$output_file"

    # Commit and push the new YAML file to the repository
    cd $OUTPUT_DIR
    git add "$output_file"
    git commit -m "$COMMIT_MESSAGE"
    git push
    cd -
done
